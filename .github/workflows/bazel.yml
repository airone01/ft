name: Bazel CI

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'milestone-*/**/*.c'
      - 'milestone-*/**/*.cpp'
      - 'milestone-*/**/*.cc'
      - 'milestone-*/**/*.cxx'
      - 'milestone-*/**/*.h'
      - 'milestone-*/**/*.hpp'
      - 'milestone-*/**/*.hh'
      - 'milestone-*/**/*.hxx'
      - 'milestone-*/**/*.bazel'
      - 'milestone-*/**/*.lock'
      - '.github/workflows/bazel.yml'
  pull_request:
    paths:
      - 'milestone-*/**/*.c'
      - 'milestone-*/**/*.cpp'
      - 'milestone-*/**/*.cc'
      - 'milestone-*/**/*.cxx'
      - 'milestone-*/**/*.h'
      - 'milestone-*/**/*.hpp'
      - 'milestone-*/**/*.hh'
      - 'milestone-*/**/*.hxx'
      - 'milestone-*/**/*.bazel'
      - 'milestone-*/**/*.lock'
      - '.github/workflows/bazel.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    timeout-minutes: 5

    steps:
    - uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          libtool \
          pkg-config \
          xutils-dev \
          libx11-dev \
          x11proto-dev

    - name: Generate libXpm config.h
      run: |
        cd external-libs/libXpm
        autoreconf -vfi
        ./configure

    - name: Cache Bazel
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/bazel
        # Key includes OS and a hash of files that likely change dependencies
        key: ${{ runner.os }}-bazel-${{ hashFiles('.bazelversion', '.bazelrc', 'MODULE.bazel', 'WORKSPACE') }}
        restore-keys: |
          ${{ runner.os }}-bazel-

    - name: Setup Bazel
      uses: bazelbuild/setup-bazelisk@v3

    - name: Build All Targets
      run: bazel build //...

    - name: Test All Targets
      run: bazel test //...
